<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <link rel="stylesheet" href="Modal.css">
</head>
<body>
    <script type='text/javascript' src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <script src="http://datamaps.github.io/scripts/datamaps.world.min.js?v=1"></script>
    <script type='text/javascript' src='Mappings.js'></script>

    <h2>Endangered Animals</h2>
    <p><a href="http://endangered-animals.me">Endangered Animals Homepage</a></p>
    <div id="container1" style="position: relative; width: 80%; max-height: 450px;"></div>

    <!-- The Modal -->
    <div id="Modal" class="modal">
          <!-- Modal content -->
        <div class="modal-content">
            <span class="close">&times;</span>
            <p>Some text in the Modal..</p>
        </div>
    </div>

    <script>
        // Get the modal
        var modal = document.getElementById('Modal');

        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];

        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
            modal.style.display = "none";
        }

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    </script>


    <script>
        var map = new Datamap({
            scope: 'world',
            element: document.getElementById('container1'),
            projection: 'mercator',
            height: 1000,
            fills: {
                defaultFill: '#4ba50e',
                lt50: 'rgba(0,244,244,0.9)',
                gt50: 'red'
            },
            geographyConfig: {
                popupOnHover:true,
                highlightOnHover: true,
                popupTemplate: function(geo, data) {
                    return ['<div class="hoverinfo"><strong>',
                            geo.properties.name,
                            '</strong></div>'].join('');
                }
            },
            done: function(datamap) {
                datamap.svg.selectAll('.datamaps-subunit').on('click', function(geography) {
                    console.log("click detected!")
                    var country_code = geography.id;
                    try {
                        var url = url_mappings[country_code].country_url
                        httpGetAsync(url, formatData);
                    }
                    catch (TypeError) {
                        console.error("No Data on " + geography.properties.name)
                    }
                });
            }
        })

        function httpGetAsync(theUrl, callback) {
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.onreadystatechange = function() {
                if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
                    callback(xmlHttp.responseText);
                }
            };

            xmlHttp.open("GET", theUrl, true); // true for asynchronous
            xmlHttp.send();
        }

        function formatData(data) {
            // console.log(data);
            var obj = JSON.parse(data);
            var output = "";
            for( i = 0; i < obj.assoc_animals.length; i++ ) {
                output = output + (obj.assoc_animals[i] + (obj.assoc_animals.length > 1 ? ", " : ""));
            }

            modal.style.display = "block";
            // alert([output].join(''));
        }
    </script>
</body>